{% extends "base.html" %}
{% block title %}回测系统 - 跟随庄家自动交易系统{% endblock %}
{% block content %}
<div class="container">
    <h1 class="mt-4 mb-4">策略回测系统</h1>

    <!-- 回测表单 -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">回测参数设置</h5>
        </div>
        <div class="card-body">
            <form id="backtest-form">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="symbol" class="form-label">交易品种</label>
                            <input type="text" class="form-control" id="symbol" name="symbol" placeholder="例如：AAPL、BTC/USDT" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="initial_capital" class="form-label">初始资金</label>
                            <input type="number" class="form-control" id="initial_capital" name="initial_capital" value="1000000" required>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="start_date" class="form-label">开始日期</label>
                            <input type="date" class="form-control" id="start_date" name="start_date" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="end_date" class="form-label">结束日期</label>
                            <input type="date" class="form-control" id="end_date" name="end_date" required>
                        </div>
                    </div>
                </div>

                <h5 class="mt-4 mb-3">策略参数</h5>
                <div class="row">
                    {% for param_name, param_value in strategy_params.items() %}
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="{{ param_name }}" class="form-label">{{ param_name }}</label>
                            <input type="number" class="form-control" id="{{ param_name }}" name="strategy_params[{{ param_name }}]" value="{{ param_value }}" step="any">
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <div class="text-end mt-4">
                    <button type="submit" class="btn btn-primary">开始回测</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 回测结果 -->
    <div id="backtest-results" class="d-none">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">回测结果</h5>
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs" id="resultTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab" aria-controls="overview" aria-selected="true">概览</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="charts-tab" data-bs-toggle="tab" data-bs-target="#charts" type="button" role="tab" aria-controls="charts" aria-selected="false">图表</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="trades-tab" data-bs-toggle="tab" data-bs-target="#trades" type="button" role="tab" aria-controls="trades" aria-selected="false">交易记录</button>
                    </li>
                </ul>
                <div class="tab-content p-3" id="resultTabsContent">
                    <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card mb-3">
                                    <div class="card-header">收益指标</div>
                                    <div class="card-body">
                                        <table class="table table-sm">
                                            <tbody id="performance-metrics">
                                                <!-- 性能指标将通过JS填充 -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card mb-3">
                                    <div class="card-header">风险指标</div>
                                    <div class="card-body">
                                        <table class="table table-sm">
                                            <tbody id="risk-metrics">
                                                <!-- 风险指标将通过JS填充 -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="charts" role="tabpanel" aria-labelledby="charts-tab">
                        <div class="row">
                            <div class="col-12 mb-4">
                                <div id="equity-curve-chart" style="height: 400px;"></div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <div id="drawdown-chart" style="height: 300px;"></div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <div id="monthly-returns-chart" style="height: 300px;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="trades" role="tabpanel" aria-labelledby="trades-tab">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="trades-table">
                                <thead>
                                    <tr>
                                        <th>日期</th>
                                        <th>品种</th>
                                        <th>操作</th>
                                        <th>价格</th>
                                        <th>数量</th>
                                        <th>金额</th>
                                        <th>佣金</th>
                                        <th>税费</th>
                                        <th>收益</th>
                                        <th>收益率</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- 交易记录将通过JS填充 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 参数优化 -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">参数优化</h5>
        </div>
        <div class="card-body">
            <form id="optimization-form">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="algorithm_select" class="form-label">选择算法</label>
                            <select class="form-select" id="algorithm_select" name="algorithm">
                                <!-- 将通过JavaScript填充算法选项 -->
                            </select>
                            <small class="form-text text-muted">选择要优化的算法，将自动显示对应参数</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="optimization_method" class="form-label">优化方法</label>
                            <select class="form-select" id="optimization_method" name="optimization_method">
                                <option value="grid_search">网格搜索优化器 - 穷举参数空间</option>
                                <option value="random_search">随机搜索优化器 - 随机采样参数空间</option>
                                <option value="bayesian">贝叶斯优化器 - 基于高斯过程</option>
                                <option value="genetic">遗传算法优化器 - 基于进化算法</option>
                                <option value="particle_swarm">粒子群优化器 - 基于群体智能</option>
                                <option value="simulated_annealing">模拟退火优化器 - 基于退火过程</option>
                                <option value="multi_objective">多目标优化器 - 同时优化多个指标</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 算法参数设置区域 -->
                <div id="algorithm_params_container" class="mb-4">
                    <!-- 参数将通过JavaScript动态生成 -->
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="optimization_target" class="form-label">优化目标</label>
                            <select class="form-select" id="optimization_target" name="optimization_target">
                                <!-- 将通过JavaScript根据算法动态生成优化目标 -->
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="optimization_iterations" class="form-label">优化迭代次数</label>
                            <input type="number" class="form-control" id="optimization_iterations" name="optimization_iterations" value="100" min="10" max="10000">
                            <small class="form-text text-muted">迭代次数越多，结果越精确，但耗时越长</small>
                        </div>
                    </div>
                </div>

                <!-- 多目标优化设置 -->
                <div id="multi-objective-settings" class="d-none">
                    <div class="row mb-3">
                        <div class="col-12">
                            <label class="form-label">多目标优化指标选择 (最少选择2个)</label>
                            <div class="d-flex flex-wrap gap-3">
                                <div class="form-check">
                                    <input class="form-check-input objective-check" type="checkbox" value="sharpe_ratio" id="obj_sharpe_ratio" name="multi_objectives">
                                    <label class="form-check-label" for="obj_sharpe_ratio">夏普比率</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input objective-check" type="checkbox" value="annual_return" id="obj_annual_return" name="multi_objectives">
                                    <label class="form-check-label" for="obj_annual_return">年化收益率</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input objective-check" type="checkbox" value="calmar_ratio" id="obj_calmar_ratio" name="multi_objectives">
                                    <label class="form-check-label" for="obj_calmar_ratio">卡玛比率</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input objective-check" type="checkbox" value="sortino_ratio" id="obj_sortino_ratio" name="multi_objectives">
                                    <label class="form-check-label" for="obj_sortino_ratio">索提诺比率</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input objective-check" type="checkbox" value="win_rate" id="obj_win_rate" name="multi_objectives">
                                    <label class="form-check-label" for="obj_win_rate">胜率</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input objective-check" type="checkbox" value="profit_loss_ratio" id="obj_profit_loss_ratio" name="multi_objectives">
                                    <label class="form-check-label" for="obj_profit_loss_ratio">盈亏比</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input objective-check" type="checkbox" value="max_drawdown" id="obj_max_drawdown" name="multi_objectives">
                                    <label class="form-check-label" for="obj_max_drawdown">最大回撤 (最小化)</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 高级算法参数 -->
                <div class="accordion mb-3" id="advancedSettingsAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="advancedSettingsHeading">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#advancedSettingsCollapse" aria-expanded="false" aria-controls="advancedSettingsCollapse">
                                高级优化选项
                            </button>
                        </h2>
                        <div id="advancedSettingsCollapse" class="accordion-collapse collapse" aria-labelledby="advancedSettingsHeading" data-bs-parent="#advancedSettingsAccordion">
                            <div class="accordion-body">
                                <!-- 网格搜索参数 -->
                                <div id="grid-search-params" class="algorithm-params">
                                    <div class="mb-3">
                                        <label class="form-label">并行计算</label>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="grid_parallel" name="algorithm_params[grid_search][parallel]" checked>
                                            <label class="form-check-label" for="grid_parallel">启用并行计算</label>
                                        </div>
                                    </div>
                                </div>

                                <!-- 随机搜索参数 -->
                                <div id="random-search-params" class="algorithm-params d-none">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="random_samples" class="form-label">随机采样数量</label>
                                                <input type="number" class="form-control" id="random_samples" name="algorithm_params[random_search][samples]" value="100" min="10" max="10000">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">并行计算</label>
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" id="random_parallel" name="algorithm_params[random_search][parallel]" checked>
                                                    <label class="form-check-label" for="random_parallel">启用并行计算</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 贝叶斯优化参数 -->
                                <div id="bayesian-params" class="algorithm-params d-none">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="bayes_init_points" class="form-label">初始点数量</label>
                                                <input type="number" class="form-control" id="bayes_init_points" name="algorithm_params[bayesian][init_points]" value="5" min="1" max="50">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="bayes_acq" class="form-label">采集函数</label>
                                                <select class="form-select" id="bayes_acq" name="algorithm_params[bayesian][acq]">
                                                    <option value="ucb">上置信界限 (UCB)</option>
                                                    <option value="ei">期望改进 (EI)</option>
                                                    <option value="poi">改进概率 (POI)</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 遗传算法参数 -->
                                <div id="genetic-params" class="algorithm-params d-none">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="genetic_pop_size" class="form-label">种群大小</label>
                                                <input type="number" class="form-control" id="genetic_pop_size" name="algorithm_params[genetic][pop_size]" value="50" min="10" max="1000">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="genetic_mutation_rate" class="form-label">变异率</label>
                                                <input type="number" class="form-control" id="genetic_mutation_rate" name="algorithm_params[genetic][mutation_rate]" value="0.1" min="0.01" max="0.5" step="0.01">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="genetic_crossover_rate" class="form-label">交叉率</label>
                                                <input type="number" class="form-control" id="genetic_crossover_rate" name="algorithm_params[genetic][crossover_rate]" value="0.7" min="0.1" max="0.9" step="0.1">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="text-end mt-4">
                    <button type="submit" class="btn btn-primary" id="start-optimization">开始优化</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 优化结果显示 -->
    <div id="optimization-results" class="card mb-4 d-none">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">参数优化结果</h5>
            <button type="button" class="btn-close" aria-label="关闭" id="close-optimization-results"></button>
        </div>
        <div class="card-body">
            <ul class="nav nav-tabs" id="optimizationTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="best-params-tab" data-bs-toggle="tab" data-bs-target="#best-params" type="button" role="tab" aria-controls="best-params" aria-selected="true">最佳参数</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="all-results-tab" data-bs-toggle="tab" data-bs-target="#all-results" type="button" role="tab" aria-controls="all-results" aria-selected="false">所有结果</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="optimization-charts-tab" data-bs-toggle="tab" data-bs-target="#optimization-charts" type="button" role="tab" aria-controls="optimization-charts" aria-selected="false">参数分布图</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="pareto-front-tab" data-bs-toggle="tab" data-bs-target="#pareto-front" type="button" role="tab" aria-controls="pareto-front" aria-selected="false">帕累托前沿</button>
                </li>
            </ul>
            <div class="tab-content p-3" id="optimizationTabsContent">
                <!-- 最佳参数 -->
                <div class="tab-pane fade show active" id="best-params" role="tabpanel" aria-labelledby="best-params-tab">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header">最优参数组合</div>
                                <div class="card-body">
                                    <table class="table table-sm">
                                        <tbody id="best-parameters">
                                            <!-- 最佳参数将通过JS填充 -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header">回测指标</div>
                                <div class="card-body">
                                    <table class="table table-sm">
                                        <tbody id="best-metrics">
                                            <!-- 最佳参数的回测指标将通过JS填充 -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12 text-center">
                            <button id="apply-best-params" class="btn btn-success">应用最佳参数</button>
                            <button id="run-backtest-with-best" class="btn btn-primary ms-2">使用最佳参数回测</button>
                        </div>
                    </div>
                </div>
                
                <!-- 所有结果 -->
                <div class="tab-pane fade" id="all-results" role="tabpanel" aria-labelledby="all-results-tab">
                    <div class="table-responsive">
                        <table id="optimization-results-table" class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>排名</th>
                                    <th>参数组合</th>
                                    <th id="objective-col">目标指标</th>
                                    <th>年化收益率</th>
                                    <th>最大回撤</th>
                                    <th>夏普比率</th>
                                    <th>卡玛比率</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- 优化结果将通过JS填充 -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- 参数分布图 -->
                <div class="tab-pane fade" id="optimization-charts" role="tabpanel" aria-labelledby="optimization-charts-tab">
                    <div class="row">
                        <div class="col-12 mb-4">
                            <div id="param-impact-chart" style="height: 400px;"></div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <div id="param-distribution-chart" style="height: 300px;"></div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div id="objective-history-chart" style="height: 300px;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- 帕累托前沿（仅多目标优化） -->
                <div class="tab-pane fade" id="pareto-front" role="tabpanel" aria-labelledby="pareto-front-tab">
                    <div class="row">
                        <div class="col-12 mb-4">
                            <div id="pareto-front-chart" style="height: 400px;"></div>
                        </div>
                    </div>
                    <div class="table-responsive mt-3">
                        <table id="pareto-solutions-table" class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>解编号</th>
                                    <th>参数组合</th>
                                    <th id="objective1-col">目标1</th>
                                    <th id="objective2-col">目标2</th>
                                    <th id="objective3-col">目标3</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- 帕累托解集将通过JS填充 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 优化任务列表 -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">参数优化历史</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="optimization-tasks-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>交易品种</th>
                            <th>优化方法</th>
                            <th>目标指标</th>
                            <th>开始时间</th>
                            <th>状态</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 优化任务将通过JS填充 -->
                    </tbody>
                </table>
            </div>
            <div id="no-optimization-tasks" class="text-center py-3">
                <p>暂无参数优化历史记录</p>
            </div>
        </div>
    </div>

    <!-- 历史回测记录 -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">历史回测记录</h5>
        </div>
        <div class="card-body">
            {% if backtest_results %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>品种</th>
                            <th>开始日期</th>
                            <th>结束日期</th>
                            <th>初始资金</th>
                            <th>最终资金</th>
                            <th>总收益率</th>
                            <th>年化收益率</th>
                            <th>夏普比率</th>
                            <th>最大回撤</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for result in backtest_results %}
                        <tr>
                            <td>{{ result.id }}</td>
                            <td>{{ result.symbol }}</td>
                            <td>{{ result.metrics.start_date }}</td>
                            <td>{{ result.metrics.end_date }}</td>
                            <td>{{ result.metrics.initial_capital|round|int }}</td>
                            <td>{{ result.metrics.final_capital|round|int }}</td>
                            <td>{{ (result.metrics.total_return * 100)|round(2) }}%</td>
                            <td>{{ (result.metrics.annual_return * 100)|round(2) }}%</td>
                            <td>{{ result.metrics.sharpe_ratio|round(2) }}</td>
                            <td>{{ (result.metrics.max_drawdown * 100)|round(2) }}%</td>
                            <td>
                                <button class="btn btn-sm btn-primary view-result" data-backtest-id="{{ result.id }}">查看</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-center my-3">暂无历史回测记录</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- 回测和优化的JavaScript代码 -->
<script>
    // 初始化日期选择器
    document.addEventListener('DOMContentLoaded', function() {
        // 设置默认日期范围（过去一年）
        const today = new Date();
        const oneYearAgo = new Date();
        oneYearAgo.setFullYear(today.getFullYear() - 1);

        document.getElementById('start_date').valueAsDate = oneYearAgo;
        document.getElementById('end_date').valueAsDate = today;

        // 参数范围切换
        document.querySelectorAll('.param-toggle').forEach(toggle => {
            toggle.addEventListener('change', function() {
                const paramName = this.dataset.param;
                const rangeInputs = document.getElementById(`range_${paramName}`);

                if (this.checked) {
                    rangeInputs.classList.remove('d-none');
                    // 设置默认值
                    const currentValue = parseFloat(document.getElementById(paramName).value);
                    rangeInputs.querySelector('input[placeholder="最小值"]').value = (currentValue * 0.5).toFixed(4);
                    rangeInputs.querySelector('input[placeholder="最大值"]').value = (currentValue * 1.5).toFixed(4);
                    rangeInputs.querySelector('input[placeholder="步长"]').value = (currentValue * 0.1).toFixed(4);
                } else {
                    rangeInputs.classList.add('d-none');
                }
            });
        });

        // 回测表单提交
        document.getElementById('backtest-form').addEventListener('submit', function(e) {
            e.preventDefault();

            // 显示加载状态
            document.getElementById('backtest-results').classList.add('d-none');
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 正在回测...';

            // 收集表单数据
            const formData = new FormData(this);
            const data = {
                symbol: formData.get('symbol'),
                start_date: formData.get('start_date'),
                end_date: formData.get('end_date'),
                initial_capital: parseFloat(formData.get('initial_capital')),
                strategy_params: {}
            };

            // 收集策略参数
            document.querySelectorAll('[name^="strategy_params["]').forEach(input => {
                const paramName = input.name.match(/\[(.*?)\]/)[1];
                data.strategy_params[paramName] = parseFloat(input.value);
            });

            // 发送回测请求
            fetch('/api/backtest/run', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // 回测成功，获取结果
                    return fetch(`/api/backtest/results?backtest_id=${result.backtest_id}`);
                } else {
                    throw new Error(result.message || '回测失败');
                }
            })
            .then(response => response.json())
            .then(resultData => {
                if (resultData.success) {
                    // 显示回测结果
                    displayBacktestResults(resultData.data);
                    document.getElementById('backtest-results').classList.remove('d-none');
                    // 滚动到结果区域
                    document.getElementById('backtest-results').scrollIntoView({ behavior: 'smooth' });
                } else {
                    throw new Error(resultData.message || '获取回测结果失败');
                }
            })
            .catch(error => {
                console.error('回测错误:', error);
                alert(`回测失败: ${error.message}`);
            })
            .finally(() => {
                // 恢复按钮状态
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            });
        });

        // 参数优化表单提交
        document.getElementById('optimization-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // 显示加载状态
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 正在优化...';
            
            // 收集基本表单数据
            const data = {
                symbol: document.getElementById('symbol').value,
                start_date: document.getElementById('start_date').value,
                end_date: document.getElementById('end_date').value,
                initial_capital: parseFloat(document.getElementById('initial_capital').value),
                optimization_method: document.getElementById('optimization_method').value,
                param_ranges: {},
                algorithm_params: {}
            };
            
            // 收集目标指标
            if (data.optimization_method === 'multi_objective') {
                data.multi_objectives = [];
                document.querySelectorAll('.objective-check:checked').forEach(check => {
                    data.multi_objectives.push(check.value);
                });
            } else {
                data.optimization_target = document.getElementById('optimization_target').value;
            }
            
            // 收集参数范围
            document.querySelectorAll('.param-toggle:checked').forEach(param => {
                const paramName = param.dataset.param;
                const rangeInputs = document.getElementById(`range_${paramName}`).querySelectorAll('input');
                
                data.param_ranges[paramName] = {
                    min: parseFloat(rangeInputs[0].value),
                    max: parseFloat(rangeInputs[1].value),
                    step: parseFloat(rangeInputs[2].value)
                };
            });
            
            // 收集算法特定参数
            const methodKey = data.optimization_method;
            const paramPanel = document.querySelector(`#${methodKey.replace(/_/g, '-')}-params`);
            if (paramPanel) {
                const inputs = paramPanel.querySelectorAll('input, select');
                const algorithmParams = {};
                
                inputs.forEach(input => {
                    let value;
                    if (input.type === 'checkbox') {
                        value = input.checked;
                    } else if (input.type === 'number') {
                        value = parseFloat(input.value);
                    } else {
                        value = input.value;
                    }
                    
                    // 从name属性中提取参数名，例如：algorithm_params[grid_search][parallel]
                    const matches = input.name.match(/algorithm_params\[([^\]]+)\]\[([^\]]+)\]/);
                    if (matches && matches.length === 3) {
                        const method = matches[1];
                        const param = matches[2];
                        
                        if (!algorithmParams[method]) {
                            algorithmParams[method] = {};
                        }
                        
                        algorithmParams[method][param] = value;
                    }
                });
                
                data.algorithm_params = algorithmParams;
            }
            
            // 发送优化请求
            fetch('/api/backtest/optimize', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    const optimizationId = result.optimization_id;
                    
                    // 如果是同步返回结果
                    if (result.status === 'completed' && result.results) {
                        displayOptimizationResults(result.results, data.optimization_method, 
                            data.optimization_method === 'multi_objective' ? data.multi_objectives : data.optimization_target);
                    } else {
                        // 异步任务，添加到任务列表
                        addOptimizationTask(optimizationId, data.symbol, data.optimization_method, 
                            data.optimization_method === 'multi_objective' ? data.multi_objectives.join(', ') : data.optimization_target, 
                            result.status);
                            
                        // 如果任务正在进行中，启动轮询
                        if (result.status === 'running') {
                            pollOptimizationStatus(optimizationId);
                        }
                        
                        alert(`参数优化任务已提交，优化ID: ${optimizationId}`);
                    }
                } else {
                    throw new Error(result.message || '参数优化失败');
                }
            })
            .catch(error => {
                console.error('优化错误:', error);
                alert(`参数优化失败: ${error.message}`);
            })
            .finally(() => {
                // 恢复按钮状态
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            });
        });
        
        // 轮询优化任务状态
        function pollOptimizationStatus(optimizationId, interval = 5000) {
            const statusCheck = setInterval(() => {
                fetch(`/api/backtest/optimization_status?optimization_id=${optimizationId}`)
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        // 更新任务状态
                        updateOptimizationTaskStatus(optimizationId, result.status);
                        
                        // 如果任务完成，停止轮询并显示结果
                        if (result.status === 'completed') {
                            clearInterval(statusCheck);
                            
                            // 获取并显示结果
                            fetch(`/api/backtest/optimization_results?optimization_id=${optimizationId}`)
                            .then(response => response.json())
                            .then(resultData => {
                                if (resultData.success) {
                                    displayOptimizationResults(resultData.results, resultData.method, resultData.target);
                                }
                            })
                            .catch(console.error);
                        } else if (result.status === 'failed') {
                            clearInterval(statusCheck);
                            alert(`优化任务 ${optimizationId} 失败：${result.error || '未知错误'}`);
                        }
                    }
                })
                .catch(error => {
                    console.error('状态查询错误:', error);
                    clearInterval(statusCheck);
                });
            }, interval);
        }
        
        // 添加优化任务到列表
        function addOptimizationTask(id, symbol, method, target, status) {
            const noTasksMessage = document.getElementById('no-optimization-tasks');
            if (noTasksMessage) {
                noTasksMessage.style.display = 'none';
            }
            
            const taskTable = document.getElementById('optimization-tasks-table').querySelector('tbody');
            const row = document.createElement('tr');
            row.setAttribute('data-optimization-id', id);
            
            // 格式化优化方法名称
            let methodName;
            switch(method) {
                case 'grid_search': methodName = '网格搜索'; break;
                case 'random_search': methodName = '随机搜索'; break;
                case 'bayesian': methodName = '贝叶斯优化'; break;
                case 'genetic': methodName = '遗传算法'; break;
                case 'particle_swarm': methodName = '粒子群优化'; break;
                case 'simulated_annealing': methodName = '模拟退火'; break;
                case 'multi_objective': methodName = '多目标优化'; break;
                default: methodName = method;
            }
            
            // 格式化状态
            let statusText, statusClass;
            switch(status) {
                case 'pending': 
                    statusText = '等待中'; 
                    statusClass = 'text-secondary';
                    break;
                case 'running': 
                    statusText = '运行中'; 
                    statusClass = 'text-primary';
                    break;
                case 'completed': 
                    statusText = '已完成'; 
                    statusClass = 'text-success';
                    break;
                case 'failed': 
                    statusText = '失败'; 
                    statusClass = 'text-danger';
                    break;
                default: 
                    statusText = status; 
                    statusClass = '';
            }
            
            row.innerHTML = `
                <td>${id}</td>
                <td>${symbol}</td>
                <td>${methodName}</td>
                <td>${target}</td>
                <td>${new Date().toLocaleString('zh-CN')}</td>
                <td class="${statusClass}" data-status="${status}">${statusText}</td>
                <td>
                    <button class="btn btn-sm btn-primary view-optimization" data-optimization-id="${id}" ${status !== 'completed' ? 'disabled' : ''}>查看结果</button>
                </td>
            `;
            
            taskTable.appendChild(row);
            
            // 添加查看结果事件
            const viewBtn = row.querySelector('.view-optimization');
            viewBtn.addEventListener('click', function() {
                const optimizationId = this.dataset.optimizationId;
                fetchAndDisplayOptimizationResults(optimizationId);
            });
        }
        
        // 更新优化任务状态
        function updateOptimizationTaskStatus(id, status) {
            const row = document.querySelector(`#optimization-tasks-table tbody tr[data-optimization-id="${id}"]`);
            if (row) {
                const statusCell = row.querySelector('td[data-status]');
                const viewBtn = row.querySelector('.view-optimization');
                
                // 更新状态文本和样式
                let statusText, statusClass;
                switch(status) {
                    case 'pending': 
                        statusText = '等待中'; 
                        statusClass = 'text-secondary';
                        break;
                    case 'running': 
                        statusText = '运行中'; 
                        statusClass = 'text-primary';
                        break;
                    case 'completed': 
                        statusText = '已完成'; 
                        statusClass = 'text-success';
                        viewBtn.removeAttribute('disabled');
                        break;
                    case 'failed': 
                        statusText = '失败'; 
                        statusClass = 'text-danger';
                        break;
                    default: 
                        statusText = status; 
                        statusClass = '';
                }
                
                statusCell.textContent = statusText;
                statusCell.className = statusClass;
                statusCell.dataset.status = status;
            }
        }
        
        // 获取并显示优化结果
        function fetchAndDisplayOptimizationResults(optimizationId) {
            fetch(`/api/backtest/optimization_results?optimization_id=${optimizationId}`)
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    displayOptimizationResults(result.results, result.method, result.target);
                } else {
                    throw new Error(result.message || '获取优化结果失败');
                }
            })
            .catch(error => {
                console.error('获取优化结果错误:', error);
                alert(`获取优化结果失败: ${error.message}`);
            });
        }
        
        // 显示优化结果
        function displayOptimizationResults(results, method, target) {
            const resultsContainer = document.getElementById('optimization-results');
            
            // 根据优化方法决定显示哪些标签页
            const paretoFrontTab = document.getElementById('pareto-front-tab').parentElement;
            if (method === 'multi_objective') {
                paretoFrontTab.style.display = '';
            } else {
                paretoFrontTab.style.display = 'none';
            }
            
            // 显示最佳参数
            if (results.best_parameters) {
                displayBestParameters(results.best_parameters, results.best_metrics);
            }
            
            // 显示所有结果
            if (results.all_results) {
                displayAllResults(results.all_results, target);
            }
            
            // 显示参数分布图
            if (results.charts && results.charts.parameter_distribution) {
                displayParameterDistributionChart(results.charts.parameter_distribution);
            }
            
            // 如果是多目标优化，显示帕累托前沿
            if (method === 'multi_objective' && results.pareto_front) {
                displayParetoFront(results.pareto_front, target);
            }
            
            // 显示结果容器
            resultsContainer.classList.remove('d-none');
            resultsContainer.scrollIntoView({ behavior: 'smooth' });
            
            // 绑定关闭按钮事件
            document.getElementById('close-optimization-results').addEventListener('click', function() {
                resultsContainer.classList.add('d-none');
            });
            
            // 绑定应用最佳参数按钮事件
            document.getElementById('apply-best-params').addEventListener('click', function() {
                applyBestParameters(results.best_parameters);
            });
            
            // 绑定使用最佳参数回测按钮事件
            document.getElementById('run-backtest-with-best').addEventListener('click', function() {
                runBacktestWithBestParameters(results.best_parameters);
            });
        }
        
        // 显示最佳参数
        function displayBestParameters(parameters, metrics) {
            const bestParamsTable = document.getElementById('best-parameters');
            const bestMetricsTable = document.getElementById('best-metrics');
            
            // 清空现有内容
            bestParamsTable.innerHTML = '';
            bestMetricsTable.innerHTML = '';
            
            // 添加参数
            for (const [param, value] of Object.entries(parameters)) {
                bestParamsTable.innerHTML += `
                    <tr>
                        <td>${param}</td>
                        <td class="text-end">${typeof value === 'number' ? value.toFixed(4) : value}</td>
                    </tr>
                `;
            }
            
            // 添加指标
            const keyMetrics = {
                'annual_return': '年化收益率',
                'max_drawdown': '最大回撤',
                'sharpe_ratio': '夏普比率',
                'calmar_ratio': '卡玛比率',
                'sortino_ratio': '索提诺比率',
                'win_rate': '胜率',
                'profit_loss_ratio': '盈亏比'
            };
            
            for (const [key, label] of Object.entries(keyMetrics)) {
                if (metrics[key] !== undefined) {
                    let value = metrics[key];
                    
                    // 格式化值
                    if (key === 'annual_return' || key === 'max_drawdown' || key === 'win_rate') {
                        value = (value * 100).toFixed(2) + '%';
                    } else if (typeof value === 'number') {
                        value = value.toFixed(2);
                    }
                    
                    bestMetricsTable.innerHTML += `
                        <tr>
                            <td>${label}</td>
                            <td class="text-end">${value}</td>
                        </tr>
                    `;
                }
            }
        }
        
        // 显示所有结果
        function displayAllResults(results, target) {
            const resultsTable = document.getElementById('optimization-results-table').querySelector('tbody');
            const objectiveCol = document.getElementById('objective-col');
            
            // 清空现有内容
            resultsTable.innerHTML = '';
            
            // 设置目标列标题
            if (typeof target === 'string') {
                switch(target) {
                    case 'sharpe_ratio': objectiveCol.textContent = '夏普比率'; break;
                    case 'annual_return': objectiveCol.textContent = '年化收益率'; break;
                    case 'calmar_ratio': objectiveCol.textContent = '卡玛比率'; break;
                    case 'sortino_ratio': objectiveCol.textContent = '索提诺比率'; break;
                    case 'win_rate': objectiveCol.textContent = '胜率'; break;
                    case 'profit_loss_ratio': objectiveCol.textContent = '盈亏比'; break;
                    case 'max_drawdown': objectiveCol.textContent = '最大回撤'; break;
                    default: objectiveCol.textContent = target;
                }
            }
            
            // 添加结果行
            results.forEach((result, index) => {
                const paramsStr = Object.entries(result.parameters)
                    .map(([key, value]) => `${key}: ${typeof value === 'number' ? value.toFixed(4) : value}`)
                    .join(', ');
                
                let targetValue;
                if (typeof target === 'string') {
                    targetValue = result.backtest_results[target];
                    if (target === 'annual_return' || target === 'win_rate' || target === 'max_drawdown') {
                        targetValue = (targetValue * 100).toFixed(2) + '%';
                    } else if (typeof targetValue === 'number') {
                        targetValue = targetValue.toFixed(4);
                    }
                } else {
                    targetValue = '-';
                }
                
                // 格式化其他指标
                const annualReturn = (result.backtest_results.annual_return * 100).toFixed(2) + '%';
                const maxDrawdown = (result.backtest_results.max_drawdown * 100).toFixed(2) + '%';
                const sharpeRatio = result.backtest_results.sharpe_ratio?.toFixed(2) || '-';
                const calmarRatio = result.backtest_results.calmar_ratio?.toFixed(2) || '-';
                
                resultsTable.innerHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${paramsStr}</td>
                        <td>${targetValue}</td>
                        <td>${annualReturn}</td>
                        <td>${maxDrawdown}</td>
                        <td>${sharpeRatio}</td>
                        <td>${calmarRatio}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary apply-params" data-index="${index}">应用</button>
                            <button class="btn btn-sm btn-outline-success run-backtest" data-index="${index}">回测</button>
                        </td>
                    </tr>
                `;
            });
            
            // 添加应用参数事件
            document.querySelectorAll('.apply-params').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    applyBestParameters(results[index].parameters);
                });
            });
            
            // 添加回测事件
            document.querySelectorAll('.run-backtest').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    runBacktestWithBestParameters(results[index].parameters);
                });
            });
        }
        
        // 显示参数分布图
        function displayParameterDistributionChart(chartData) {
            if (chartData && chartData.data && chartData.layout) {
                Plotly.newPlot('param-distribution-chart', chartData.data, chartData.layout);
            }
            
            // 如果有其他图表数据，也显示它们
            if (chartData && chartData.param_impact && chartData.param_impact.data) {
                Plotly.newPlot('param-impact-chart', chartData.param_impact.data, chartData.param_impact.layout);
            }
            
            if (chartData && chartData.objective_history && chartData.objective_history.data) {
                Plotly.newPlot('objective-history-chart', chartData.objective_history.data, chartData.objective_history.layout);
            }
        }
        
        // 显示帕累托前沿
        function displayParetoFront(paretoFront, objectives) {
            // 设置目标列标题
            if (Array.isArray(objectives) && objectives.length >= 2) {
                document.getElementById('objective1-col').textContent = getObjectiveLabel(objectives[0]);
                document.getElementById('objective2-col').textContent = getObjectiveLabel(objectives[1]);
                
                if (objectives.length >= 3) {
                    document.getElementById('objective3-col').textContent = getObjectiveLabel(objectives[2]);
                    document.getElementById('objective3-col').style.display = '';
                } else {
                    document.getElementById('objective3-col').style.display = 'none';
                }
            }
            
            // 显示帕累托前沿图
            if (paretoFront.chart && paretoFront.chart.data) {
                Plotly.newPlot('pareto-front-chart', paretoFront.chart.data, paretoFront.chart.layout);
            }
            
            // 显示帕累托解集表格
            if (paretoFront.solutions) {
                const solutionsTable = document.getElementById('pareto-solutions-table').querySelector('tbody');
                solutionsTable.innerHTML = '';
                
                paretoFront.solutions.forEach((solution, index) => {
                    const paramsStr = Object.entries(solution.parameters)
                        .map(([key, value]) => `${key}: ${typeof value === 'number' ? value.toFixed(4) : value}`)
                        .join(', ');
                    
                    let row = `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${paramsStr}</td>
                    `;
                    
                    // 添加目标值列
                    if (solution.objective_values) {
                        for (let i = 0; i < Math.min(objectives.length, 3); i++) {
                            const obj = objectives[i];
                            let value = solution.objective_values[obj];
                            
                            // 格式化目标值
                            if (obj === 'annual_return' || obj === 'win_rate' || obj === 'max_drawdown') {
                                value = (value * 100).toFixed(2) + '%';
                            } else if (typeof value === 'number') {
                                value = value.toFixed(4);
                            }
                            
                            row += `<td>${value}</td>`;
                        }
                    }
                    
                    row += `
                            <td>
                                <button class="btn btn-sm btn-outline-primary apply-pareto-solution" data-index="${index}">应用</button>
                                <button class="btn btn-sm btn-outline-success run-pareto-backtest" data-index="${index}">回测</button>
                            </td>
                        </tr>
                    `;
                    
                    solutionsTable.innerHTML += row;
                });
                
                // 添加应用参数事件
                document.querySelectorAll('.apply-pareto-solution').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const index = parseInt(this.dataset.index);
                        applyBestParameters(paretoFront.solutions[index].parameters);
                    });
                });
                
                // 添加回测事件
                document.querySelectorAll('.run-pareto-backtest').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const index = parseInt(this.dataset.index);
                        runBacktestWithBestParameters(paretoFront.solutions[index].parameters);
                    });
                });
            }
        }
        
        // 获取目标指标的可读标签
        function getObjectiveLabel(objective) {
            switch(objective) {
                case 'sharpe_ratio': return '夏普比率';
                case 'annual_return': return '年化收益率';
                case 'calmar_ratio': return '卡玛比率';
                case 'sortino_ratio': return '索提诺比率';
                case 'win_rate': return '胜率';
                case 'profit_loss_ratio': return '盈亏比';
                case 'max_drawdown': return '最大回撤';
                default: return objective;
            }
        }
        
        // 应用最佳参数
        function applyBestParameters(parameters) {
            for (const [param, value] of Object.entries(parameters)) {
                const inputEl = document.getElementById(param);
                if (inputEl) {
                    inputEl.value = value;
                }
            }
            
            // 关闭结果显示
            document.getElementById('optimization-results').classList.add('d-none');
            
            // 滚动到参数部分
            document.getElementById('backtest-form').scrollIntoView({ behavior: 'smooth' });
            
            // 显示成功提示
            alert('已应用优化参数');
        }
        
        // 使用最佳参数运行回测
        function runBacktestWithBestParameters(parameters) {
            // 先应用参数
            for (const [param, value] of Object.entries(parameters)) {
                const inputEl = document.getElementById(param);
                if (inputEl) {
                    inputEl.value = value;
                }
            }
            
            // 关闭结果显示
            document.getElementById('optimization-results').classList.add('d-none');
            
            // 滚动到回测表单
            document.getElementById('backtest-form').scrollIntoView({ behavior: 'smooth' });
            
            // 触发回测表单提交
            document.getElementById('backtest-form').dispatchEvent(new Event('submit'));
        }
    });
</script>
{% endblock %}

